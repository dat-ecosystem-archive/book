<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Merkle Tree - </title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li><a href="ch00-00-introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><a href="ch01-00-key-concepts.html"><strong aria-hidden="true">2.</strong> Key Concepts</a></li><li><ol class="section"><li><a href="ch01-01-flat-tree.html"><strong aria-hidden="true">2.1.</strong> Flat Tree</a></li><li><a href="ch01-02-merkle-tree.html" class="active"><strong aria-hidden="true">2.2.</strong> Merkle Tree</a></li><li><a href="ch01-03-bitfield.html"><strong aria-hidden="true">2.3.</strong> Bitfield</a></li><li><a href="ch01-04-storage.html"><strong aria-hidden="true">2.4.</strong> Storage</a></li></ol></li><li><a href="ch02-00-implementation-guide.html"><strong aria-hidden="true">3.</strong> Implementation Guide</a></li><li><ol class="section"><li><a href="ch02-01-flat-tree.html"><strong aria-hidden="true">3.1.</strong> Flat Tree</a></li><li><a href="ch02-02-merkle-tree-stream.html"><strong aria-hidden="true">3.2.</strong> Merkle Tree Stream</a></li><li><a href="ch02-03-memory-pager.html"><strong aria-hidden="true">3.3.</strong> Memory Pager</a></li></ol></li><li><a href="ch03-00-appendix.html"><strong aria-hidden="true">4.</strong> Appendix</a></li><li><ol class="section"><li><a href="ch03-01-terminology.html"><strong aria-hidden="true">4.1.</strong> A - Terminology</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title"></h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#merkle-tree" id="merkle-tree">Merkle Tree</a></h1>
<p>Merkle Trees in Dat are specialized <a href="./ch01-01-flat-tree">Flat Trees</a> that
contain the content of the archives.</p>
<p>In this section we'll cover how Merkle Trees work, and how we use them inside
Hypercore.</p>
<h2><a class="header" href="#what-are-merkle-trees" id="what-are-merkle-trees">What Are Merkle Trees?</a></h2>
<p>Wikipedia defines a Merkle Tree as:</p>
<blockquote>
<p>A hash tree or Merkle tree is a tree in which every leaf node is labelled with
the hash of a data block and every non-leaf node is labelled with the
cryptographic hash of the labels of its child nodes.</p>
</blockquote>
<p>In <code>flat-tree</code> terminology this means all leaf nodes (even numbers) contain
hashes of data, and all uneven numbers (parent nodes) contain hashes.</p>
<p>Take the following tree:</p>
<pre><code class="language-txt">  0──┐
     1──┐
  2──┘  │
        3
  4──┐  │
     5──┘
  6──┘
</code></pre>
<ul>
<li>Nodes 0, 2, 4, and 6 contain the hashes of data.</li>
<li>Node 1 contains the hash of hashes from nodes 0 and 2.</li>
<li>Node 5 contains the hash of hashes from nodes 4 and 6.</li>
<li>Node 3 contains the hash of hashes from nodes 1 and 5.</li>
</ul>
<h2><a class="header" href="#hypercore-files" id="hypercore-files">Hypercore Files</a></h2>
<p>A Hypercore's internal structure typically consist of these files:</p>
<ul>
<li><strong>data:</strong> a file containing the data added to the Hypercore.</li>
<li><strong>tree:</strong> a file containing the Merkle tree of hashes derived from the data.</li>
<li><strong>signatures:</strong> a file containing the cryptographic signatures of the hashes
in the tree file.</li>
<li><strong>bitfield:</strong> a file to keep track of which data we have locally, and which
data is part of the network.</li>
<li><strong>public key:</strong> a file containing the public key. This is used for verifying
content.</li>
<li><strong>secret key:</strong> a file containing the signing key. This is used for adding new
content, and is only available on Hypercores you've created.</li>
</ul>
<blockquote>
<p>The names we're using to refer to files here is also the way they're referred
to in Hypercore's specs and implementations. When inspecting a <code>.dat</code>
directory you'll see these terms used as suffixes. For example
as <code>content.tree</code>, or <code>metadata.signatures</code>.</p>
</blockquote>
<p>The tree file is responsible for verifying the integrity of the data that's
being appended to the feed.</p>
<p>The signature file is responsible for ensuring the integrity of the entire tree
at any given state. Every entry in the signature file verifies the current state
of the entire tree file.</p>
<blockquote>
<p>Not every Hypercore is the same. In most implementations of Dat it's possible
to choose how data is stored. For server applications it makes sense to store
it in a single file. But for desktop applications it can sometimes make sense
to store content directly on disk. For example in the case of (hyper)media
files.</p>
</blockquote>
<p>Let's look at how these files relate to each other to create a Hypercore feed.</p>
<h2><a class="header" href="#merkle-trees-in-theory" id="merkle-trees-in-theory">Merkle Trees In Theory</a></h2>
<p>Whenever data is added to Hypercore, a new entry is created in the data file. We
then hash the data, and write that hash to a tree file's leaf node. If the leaf
node has a sibling, the parent node's hash can be computed. If the new parent
node has a sibling, we can compute a new parent node above it. We recurse upward
until no more parent nodes can be computed, at which point we'll have reached a
root node.</p>
<p>When there are no more hashes left to compute, we gather all the root nodes in
the tree, concatenate them, hash them, and sign them with our private key. We
then store the signature in our signatures file at the same index of the leaf
node that was added.</p>
<p>This might all sound a little abstract though, so let's look at an example.</p>
<h2><a class="header" href="#merkle-trees-in-practice" id="merkle-trees-in-practice">Merkle Trees In Practice</a></h2>
<p>We're starting off with an empty Hypercore feed. We're planning to add 4 pieces
of data to it, one by one: <code>[A B C D]</code>.</p>
<h3><a class="header" href="#entry-1" id="entry-1">Entry 1</a></h3>
<p>Let's add our first piece of data to Hypercore. We insert the value &quot;A&quot; as our
first entry. In order, the following actions happen:</p>
<ol>
<li>We append the data to the data file.</li>
<li>We compute a hash (<code>#0</code>) from the data, and store it at index <code>0</code> in our tree file.</li>
<li>We gather all root nodes from our tree file (which is just the node at index
0 right now), and compute a cryptographic signature from the hash.</li>
<li>We append the signature to our signatures file.</li>
</ol>
<p><strong>data</strong></p>
<pre><code class="language-txt">0: A
</code></pre>
<p><strong>tree</strong></p>
<pre><code class="language-txt">0: #0 = hash(data[0])
</code></pre>
<p><strong>signatures</strong></p>
<pre><code class="language-txt">0: sig(#0)
</code></pre>
<h3><a class="header" href="#entry-2" id="entry-2">Entry 2</a></h3>
<p>Let's add our second entry to hypercore. We now have more nodes, which means
things are a little different:</p>
<ol>
<li>We append the data to the data file.</li>
<li>We compute a hash from the data (<code>#2</code>), and store it at index <code>1</code> in our tree file.</li>
<li>Because <code>#2</code> has a sibling hash, we compute a new parent hash (<code>#1</code>), and store
it at index <code>1</code>.</li>
<li>We gather all root nodes from our tree file, and compute a cryptographic
signature from the hash. The only root node currently available is <code>#1</code>. Note that while we compute <code>#1</code> from our tree file, we do not store it there. Only even-numbered hashes are stored in the tree file as the odd-numbered ones can be calculated from them.</li>
<li>We append the signature to our signatures file.</li>
</ol>
<blockquote>
<p>When we talk about &quot;computing a parent hash&quot; it means we concatenate (<code>+</code>) the
hashes from both child nodes, and hash the result. Hashes are always the same
length, which means every node in the tree is the same length.</p>
</blockquote>
<p><strong>data</strong></p>
<pre><code class="language-txt">0: A
1: B
</code></pre>
<p><strong>tree</strong></p>
<pre><code class="language-txt">0: #0 = hash(data[0]) ─┐
                       #1 = hash(#0 + #2)
1: #2 = hash(data[1]) ─┘
</code></pre>
<p><strong>signatures</strong></p>
<pre><code class="language-txt">0: sig(#0)
1: sig(#1)
</code></pre>
<h3><a class="header" href="#entry-3" id="entry-3">Entry 3</a></h3>
<p>So far so good. We're well on our way to building a full tree-structure! Let's
continue on our journey, and add our third entry: <code>C</code>.</p>
<ol>
<li>We append the third piece data to the data file at index <code>2</code>.</li>
<li>We compute a hash from the data (<code>#4</code>), and store it at index <code>2</code> in our tree file.</li>
<li>We now have two root hashes: <code>#1</code> and <code>#4</code>. So we concatenate them, hash the
result, and sign the result.</li>
<li>We append the signature to our signatures file.</li>
</ol>
<p><strong>data</strong></p>
<pre><code class="language-txt">0: A
1: B
2: C
</code></pre>
<p><strong>tree</strong></p>
<pre><code class="language-txt">0: #0 = hash(data[0]) ─┐
                       #1 = hash(tree[0] + tree[1])
1: #2 = hash(data[1]) ─┘

2: #4 = hash(data[2])
</code></pre>
<p><strong>signatures</strong></p>
<pre><code class="language-txt">0: sig(#0)
1: sig(#1)
2: sig(#1 + #4)
</code></pre>
<h3><a class="header" href="#entry-4" id="entry-4">Entry 4</a></h3>
<p>Let's add the final piece of data to our feed. This will balance out a tree, and
bring us back to only one root hash!</p>
<ol>
<li>We append the fourth piece data to the data file at index <code>3</code>.</li>
<li>We compute a hash from the data (<code>#6</code>), and store it at index <code>3</code> in our tree file.</li>
<li>Our only root hash is <code>#3</code>, so we sign it and compute the signature.</li>
<li>We append the signature to our signatures file.</li>
</ol>
<p><strong>data</strong></p>
<pre><code class="language-txt">0: A
1: B
2: C
3: D
</code></pre>
<p><strong>tree</strong></p>
<pre><code class="language-txt">0: #0 = hash(data[0]) ─┐
                       #1 = hash(#0 + #2) ─┐
1: #2 = hash(data[1]) ─┘                   │
                                           #3 = hash(#1 + #5)
2: #4 = hash(data[2]) ─┐                   │
                       #5 = hash(#4 + #6) ─┘
3: #6 = hash(data[3]) ─┘
</code></pre>
<p><strong>signatures</strong></p>
<pre><code class="language-txt">0: sig(#0)
1: sig(#1)
2: sig(#1 + #4)
3: sig(#3)
</code></pre>
<h2><a class="header" href="#verifying-a-merkle-tree" id="verifying-a-merkle-tree">Verifying A Merkle Tree</a></h2>
<p>TODO</p>
<h2><a class="header" href="#root-nodes" id="root-nodes">Root Nodes</a></h2>
<p>If the number of leaf nodes is a multiple of 2 the flat tree will only have a
single root. Otherwise it'll have more than one.</p>
<h2><a class="header" href="#storage-format" id="storage-format">Storage Format</a></h2>
<p>The format of the each node in the Merkle Tree on disk is a series of 40 byte
buffers. The first 32 bytes is the hash. The next 8 bytes is the byte size of
the spanning tree.</p>
<p>The format for storing nodes is:</p>
<ul>
<li>32 byte header which starts with a magic number to indicate what type of file
it is.</li>
<li>Then a series of nodes, where each index in the sequence corresponds to a
position in the Flat Tree.</li>
</ul>
<p>To read the 6th node from disk (flat tree node <code>#5</code>), you'd use an offset into
the file of <code>32 + 5 * 40</code>, and then read <code>40</code> bytes. The first 32 bytes are the
hash. The last 8 bytes is the combined length of the data nodes <code>#4</code> and <code>#6</code> are
referencing. The length is encoded as <code>uint64</code> Big Endian.</p>
<h2><a class="header" href="#references" id="references">References</a></h2>
<ul>
<li>https://gist.github.com/jimpick/54adc72f11f38f1fe4bc1d45d3981708</li>
<li>https://github.com/datrs/tree-index/issues/7#issuecomment-419086236</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="ch01-01-flat-tree.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="ch01-03-bitfield.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="ch01-01-flat-tree.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="ch01-03-bitfield.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
