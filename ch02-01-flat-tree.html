<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Flat Tree - </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">var path_to_root = "";</script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li><a href="ch00-00-introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><a href="ch01-00-key-concepts.html"><strong aria-hidden="true">2.</strong> Key Concepts</a></li><li><ol class="section"><li><a href="ch01-01-flat-tree.html"><strong aria-hidden="true">2.1.</strong> Flat Tree</a></li><li><a href="ch01-02-merkle-tree.html"><strong aria-hidden="true">2.2.</strong> Merkle Tree</a></li><li><a href="ch01-03-bitfield.html"><strong aria-hidden="true">2.3.</strong> Bitfield</a></li><li><a href="ch01-04-storage.html"><strong aria-hidden="true">2.4.</strong> Storage</a></li></ol></li><li><a href="ch02-00-implementation-guide.html"><strong aria-hidden="true">3.</strong> Implementation Guide</a></li><li><ol class="section"><li><a href="ch02-01-flat-tree.html" class="active"><strong aria-hidden="true">3.1.</strong> Flat Tree</a></li><li><a href="ch02-02-merkle-tree-stream.html"><strong aria-hidden="true">3.2.</strong> Merkle Tree Stream</a></li><li><a href="ch02-03-memory-pager.html"><strong aria-hidden="true">3.3.</strong> Memory Pager</a></li></ol></li><li><a href="ch03-00-appendix.html"><strong aria-hidden="true">4.</strong> Appendix</a></li><li><ol class="section"><li><a href="ch03-01-terminology.html"><strong aria-hidden="true">4.1.</strong> A - Terminology</a></li></ol></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title"></h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#flat-tree" id="flat-tree"><h1>flat-tree</h1></a>
<p><code>flat-tree</code> is one of the first modules that should be implemented for the Dat
protocol. See <a href="/ch01-01-flat-tree.html">Key Concepts: Flat Tree</a> for an overview
of how Flat Trees work.</p>
<a class="header" href="#core-api" id="core-api"><h2>Core API</h2></a>
<p>The core flat-tree API consists of several methods that can calculate the nodes
relative to each other.</p>
<a class="header" href="#children" id="children"><h3>Children</h3></a>
<p>Returns both children of a node. It cannot return any children when querying a
leaf node, so the result must be a <code>Null</code>, <code>Maybe</code>, or <code>Option</code> type, depending
on the language used.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub fn children_with_depth(i: usize, depth: usize) -&gt; Option&lt;(usize, usize)&gt;
#}</code></pre></pre>
<a class="header" href="#count" id="count"><h3>count</h3></a>
<p>Returns how many nodes are under the tree that the node spans.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub fn count_with_depth(i: usize) -&gt; usize
#}</code></pre></pre>
<a class="header" href="#depth" id="depth"><h3>depth</h3></a>
<p>Returns the depth of a node at a given index.
is removed from the left-most node at its current depth</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub fn depth(i: usize) -&gt; usize
#}</code></pre></pre>
<a class="header" href="#full_roots" id="full_roots"><h3>full_roots</h3></a>
<p>Returns a list of all the full roots (subtrees where all nodes have either 2 or
0 children).</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub fn full_roots(i: usize) -&gt; Vec&lt;usize&gt;{
#}</code></pre></pre>
<a class="header" href="#index" id="index"><h3>index</h3></a>
<p>Return the index for a node at at given depth and offset.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub fn index(depth: usize, offset: usize) -&gt; usize
#}</code></pre></pre>
<a class="header" href="#left_child" id="left_child"><h3>left_child</h3></a>
<p>Return the left child of the node at index.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub fn left_child(i: usize) -&gt; Option&lt;usize&gt;
#}</code></pre></pre>
<a class="header" href="#left_span" id="left_span"><h3>left_span</h3></a>
<p>Returns the left-most child of the node at index.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub fn left_span(i: usize) -&gt; usize
#}</code></pre></pre>
<a class="header" href="#offset" id="offset"><h3>offset</h3></a>
<p>Returns the offset of a node at a given index. The offset of a node is how far
it is removed from the left-most node at its current depth</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub fn offset(i: usize) -&gt; usize
#}</code></pre></pre>
<a class="header" href="#parent" id="parent"><h3>parent</h3></a>
<p>Returns the parent of a node.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub fn parent(i: usize) -&gt; usize
#}</code></pre></pre>
<a class="header" href="#right_child" id="right_child"><h3>right_child</h3></a>
<p>Return the right child of the node at index.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub fn right_child(i: usize) -&gt; Option&lt;usize&gt;
#}</code></pre></pre>
<a class="header" href="#right_span" id="right_span"><h3>right_span</h3></a>
<p>Returns the right-most child of the node at index.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub fn right_span(i: usize) -&gt; usize
#}</code></pre></pre>
<a class="header" href="#left_span-1" id="left_span-1"><h3>left_span</h3></a>
<p>Returns the left-most child of the node at index.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub fn right_span(i: usize) -&gt; usize
#}</code></pre></pre>
<a class="header" href="#sibling" id="sibling"><h3>sibling</h3></a>
<p>Returns the node that shares the same parent node.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub fn sibling(i: usize) -&gt; usize
#}</code></pre></pre>
<a class="header" href="#spans" id="spans"><h3>spans</h3></a>
<p>Returns a pair of the left-most node in the tree, and the right-most node in the
tree.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub fn spans(i: usize) -&gt; (usize, usize)
#}</code></pre></pre>
<a class="header" href="#uncle" id="uncle"><h3>uncle</h3></a>
<p>Returns the parent's sibling node.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub fn uncle(i: usize) -&gt; usize
#}</code></pre></pre>
<a class="header" href="#iterator-api" id="iterator-api"><h2>Iterator API</h2></a>
<p>Some upstream modules require stateful traversal of the tree. It can be
convenient to expose a stateful iterator module as part of <code>flat-tree</code> for those
cases.</p>
<p>The iterator should be a constructor that takes an initial index, and exposes
methods to move to child nodes, parent nodes, etc. The iterator should also
expose the index so it can be stored or used for other computations.</p>
<a class="header" href="#optimizations" id="optimizations"><h2>Optimizations</h2></a>
<a class="header" href="#calculate-depth" id="calculate-depth"><h3>Calculate Depth</h3></a>
<p>The depth of a node can be calculated by counting the number of tailing zeros in
a number. Languages such as Rust expose <code>&lt;num&gt;.trailing_zeros()</code> which counts
the amount of zeros at the end of a number (<code>cttz</code> intrinsic). By combining a
bitwise negation (<code>!</code> or <code>NOT</code> operation) with the <code>.trailing_zeros()</code> method,
the amount of trailing ones can be counted. On x86 machines this should be
around 3 instructions when inlined.</p>
<a class="header" href="#re-use-the-depth-parameter" id="re-use-the-depth-parameter"><h3>Re-use the depth parameter</h3></a>
<p>Sometimes when calling multiple functions on the same index, depending on the
execution environment it can be efficient to reuse the <code>depth</code> parameter.</p>
<p>However if the optimized depth method is used, there's no strict need to expose
the <code>with_depth*</code> methods, as the compiler will detect the duplicate
computation, and remove it anyway. Mileage may vary, but this technique has been
tested on LLVM output for the Rust version. In the worst case there might be
penalty of up 3 instructions per call, which seems like a negligible penalty.</p>
<a class="header" href="#calculate-children" id="calculate-children"><h3>Calculate children</h3></a>
<p>Calculating whether a node has children can be sped up by quickly checking if a
number is even or uneven. If a number is uneven, it's already guaranteed to be a
child node, so it can't have child nodes.</p>
<a class="header" href="#spans-1" id="spans-1"><h3>Spans</h3></a>
<p>Similarly for spans. If an even number is targeted, it is at the bottom of the
tree, so it will only span itself. Therefor it's easy to implement an <code>is_even</code>
check, and return the index that was passed in if it's true.</p>
<a class="header" href="#full-roots" id="full-roots"><h2>Full Roots</h2></a>
<p>To prevent allocations <code>full-roots</code> could also write to either a pre-allocated
vector, or a stack-allocated collection instead.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="ch02-00-implementation-guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="ch02-02-merkle-tree-stream.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="ch02-00-implementation-guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="ch02-02-merkle-tree-stream.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
